# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commit Guidelines

- Never add Claude attribution to commits (no Co-Authored-By, no "Generated by Claude", etc.)
- Keep commit messages concise and focused on the change

## Build Commands

```bash
# Build
go build -o sprite-bootstrap

# Run
./sprite-bootstrap zed -s <sprite-name>
./sprite-bootstrap vscode -s <sprite-name>

# Cross-compile for different platforms
GOOS=linux GOARCH=amd64 go build -o dist/sprite-bootstrap-linux-amd64
GOOS=darwin GOARCH=arm64 go build -o dist/sprite-bootstrap-darwin-arm64
GOOS=windows GOARCH=amd64 go build -o dist/sprite-bootstrap-windows-amd64.exe
```

## Architecture

sprite-bootstrap is a CLI that runs a local SSH server to proxy connections to Sprite cloud environments. Instead of requiring sshd on each sprite, it uses the Sprites API via WebSocket.

### Key Design Pattern: Tool Registry

IDEs are implemented as "tools" that register themselves at init time:

```
internal/tools/
├── tool.go          # Tool interface definition
├── registry.go      # Tool registration, Bootstrap() orchestration
├── zed.go           # Zed IDE implementation
├── vscode.go        # VS Code implementation
└── *_unix.go/*_windows.go  # Platform-specific implementations
```

To add a new IDE, create a file implementing the `Tool` interface with `Name()`, `Description()`, `Setup()`, `Instructions()`, and `Validate()`. Call `Register()` in `init()` - the command is auto-registered.

### SSH Server Flow

1. User runs `sprite-bootstrap zed -s mysprite`
2. `Bootstrap()` in registry.go wakes the sprite, starts the SSH server (if not running), runs tool setup
3. SSH server (internal/sshserver/) accepts connections where username = sprite name
4. Server authenticates by looking up the sprite via Sprites API
5. Commands are proxied to the sprite using `sprites-go` SDK over WebSocket

### Platform-Specific Code

Files ending in `_unix.go` and `_windows.go` use build tags for platform differences:
- Process management (setSysProcAttr, signalTerminate)
- Zed binary discovery (PATH vs Windows Registry)

### State Management

- PID file: `~/.sprite-bootstrap/serve.pid` (Linux), `%LOCALAPPDATA%/sprite-bootstrap/serve.pid` (Windows)
- SSH host key: `~/.ssh/sprite_bootstrap_host_ed25519_key` (auto-generated)
- Credentials: Reads from `~/.sprites/sprites.json` and system keyring
